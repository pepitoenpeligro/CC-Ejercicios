# Tema 7. Orquestación de máquinas virtuales



## Ejercicio 1

`Instalar una máquina virtual Debian usando Vagrant y conectar con ella.`

Comenzamos instalando __vagrant__ en nuestro sistema:


```bash
brew install vagrant
```

![vagrant install](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/01-vagrant-install.png)

A continuación, vamos a crear un directorio con un archivo __Vagrantfile__ que contendrá la configuración de la máquina virtual y que es lo que facilita la reproducibilidad de la configuración (y por tanto, la ventaja de usar vagrant):

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|
  config.vm.box = "centos/7"
end
```


Ahora podemos levantar la máquina virtual gracias a la especificación anterior:

```bash
vagrant up
```

![vagrant up](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/01-vagrant-up-1.png)

![vagrant up 2](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/01-vagrant-up-2.png)

Y nos concectamos por ssh a la máquina con:

```
vagrant ssh
```

![vagrant ssh](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/01-vagrant-ssh.png)


Podemos configurar el Vagrant file para que copie nuestra clave pública en la máquina de la siguiente forma:


```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|
  config.vm.box = "centos/7"
  ssh_pub_key = File.readlines("#{Dir.home}/.ssh/id_rsa.pub").first.strip
  config.vm.provision 'shell', inline: "echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys", privileged: false
end
```

![vagrant ssh](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/01-vagrant-provision-ssh.png)


## Ejercicio 2

`Instalar una máquina virtual ArchLinux o FreeBSD para KVM, usando Vagrant y conectar con ella.`


Creamos el _Vagrantfile_ como sigue

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :
Vagrant.configure("2") do |config|
  config.vm.box = "archlinux/archlinux"
  ssh_pub_key = File.readlines("#{Dir.home}/.ssh/id_rsa.pub").first.strip
  config.vm.provision 'shell', inline: "echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys", privileged: false
end
```

E indicamos el proveedor _libvirt__ ejecutando:

```bash
sudo vagrant up --provider=libvirt
```

![vagrant up](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/02-kvm-config.png)


![vagrant up](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/02-kvm.png)

Y conectamos por ssh con:


```bash
ssh vagrant@127.0.0.1 -p 2222
```

![vagrant ssh](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/02-ssh.png)




## Ejercicio 3

`Crear un script para provisionar de forma básica una máquina virtual para el proyecto que se esté llevando a cabo en la asignatura.`

Creamos un _Vagrantfile_ que contiene lo siguiente:

```ruby
# -*- mode: ruby -*-
# vi: set ft=ruby :

pathBashScript = './scripts'

Vagrant.configure("2") do |config|
    config.vm.box = "mcandre/vagrant-ubuntu-rust"
    config.vm.network "forwarded_port", guest: 80, host: 8080

    config.vm.provision "shell" do |script|
        script.path = "#{pathBashScript}/script.sh"
    end

    ssh_pub_key = File.readlines("#{Dir.home}/.ssh/id_rsa.pub").first.strip
    config.vm.provision 'shell', inline: "echo #{ssh_pub_key} >> /home/vagrant/.ssh/authorized_keys", privileged: false
end
```

En él podemos notar que hemos creado un fichero `scripts/script.sh` que contiene un simple echo para probar, y conectamos por ssh:

![vagrant ssh](https://github.com/pepitoenpeligro/CC-Ejercicios/blob/master/images/7/03-vagrant-rust.png)




## Ejercicio 4

`Configurar tu máquina virtual usando _vagrant_ con el provisionador ansible` 








## Referencias
* [Vagrantfile ssh pub keys](https://github.com/JJ/CC/blob/master/ejemplos/vbox-centos7/Vagrantfile)

